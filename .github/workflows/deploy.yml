name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  SERVER_IP: "18.141.179.222"
  APP_DIR: "/var/www/app/product-auto-test"
  NODE_VERSION: "18"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Install pnpm
      run: npm install -g pnpm
      
    - name: ğŸ”¨ Build Frontend
      working-directory: src/chat_assistant/frontend
      run: |
        # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶
        pwd
        ls -la
        
        # å®‰è£…ä¾èµ–
        pnpm install
        
        # åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
        cat > .env.production << EOF
        VITE_API_BASE_URL=http://${{ env.SERVER_IP }}:8000
        VITE_APP_ENV=production
        VITE_API_TIMEOUT=300000
        VITE_DEBUG=false
        EOF
        
        # æ˜¾ç¤ºå…³é”®æ–‡ä»¶
        echo "=== Checking key files ==="
        ls -la index.html src/main.tsx
        
        # æ„å»ºé¡¹ç›®
        pnpm build
        
    - name: ğŸ—‚ï¸ Prepare Deployment Files
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deployment
        
        # å¤åˆ¶Pythonä»£ç 
        cp -r src deployment/
        cp -r config deployment/ 2>/dev/null || true
        cp requirements.txt deployment/
        cp api_server.py deployment/
        cp start_api_server.py deployment/
        cp main.py deployment/
        cp *.py deployment/ 2>/dev/null || true
        
        # å¤åˆ¶å‰ç«¯æ„å»ºæ–‡ä»¶
        mkdir -p deployment/frontend-dist
        cp -r src/chat_assistant/frontend/dist/* deployment/frontend-dist/
        

        
    - name: ğŸ“¤ Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # åˆ›å»ºåº”ç”¨ç›®å½•
          sudo mkdir -p /var/www/app
          sudo chown $USER:$USER /var/www/app
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf ${{ env.APP_DIR }}
          mkdir -p ${{ env.APP_DIR }}
          
    - name: ğŸ“ Upload Files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deployment/*"
        target: ${{ env.APP_DIR }}
        strip_components: 1
        
    - name: ğŸš€ Execute Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd ${{ env.APP_DIR }}
          
          echo "ğŸ è®¾ç½®Pythonç¯å¢ƒ..."
          python3 -m venv venv 2>/dev/null || echo 'venvå·²å­˜åœ¨'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "âš™ï¸ è®¾ç½®ç¯å¢ƒå˜é‡..."
          cat > .env << 'ENVEOF'
          FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_VERIFICATION_TOKEN=${{ secrets.FEISHU_VERIFICATION_TOKEN }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          FIGMA_ACCESS_TOKEN=${{ secrets.FIGMA_ACCESS_TOKEN }}
          ENVIRONMENT=production
          ENVEOF
          
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          pm2 delete product-auto-test 2>/dev/null || echo 'æœåŠ¡ä¸å­˜åœ¨ï¼Œæ–°å»ºä¸­...'
          pm2 start api_server.py --name product-auto-test --interpreter $(pwd)/venv/bin/python
          pm2 save
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
    - name: ğŸ” Health Check
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
        for i in {1..5}; do
          if curl -f http://${{ env.SERVER_IP }}:8000/health; then
            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"
            break
          else
            echo "â³ æœåŠ¡è¿˜æœªå°±ç»ªï¼Œç­‰å¾…ä¸­... ($i/5)"
            sleep 10
          fi
        done
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
        echo "  - å‰ç«¯ç•Œé¢: http://${{ env.SERVER_IP }}:8000"
        echo "  - APIæœåŠ¡: http://${{ env.SERVER_IP }}:8000/api"
        echo "  - å¥åº·æ£€æŸ¥: http://${{ env.SERVER_IP }}:8000/health"
        echo ""
        echo "ğŸ“Š æœåŠ¡æ¶æ„ï¼š"
        echo "  - å‰ç«¯: Nginxé™æ€æœåŠ¡"
        echo "  - åç«¯: PM2å®ˆæŠ¤è¿›ç¨‹"
        echo "  - ä»£ç†: Nginxåå‘ä»£ç†" 