name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  SERVER_IP: "18.141.179.222"
  APP_DIR: "/var/www/app/product-auto-test"
  NODE_VERSION: "18"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Install pnpm
      run: npm install -g pnpm
      
    - name: ğŸ”¨ Build Frontend
      working-directory: src/chat_assistant/frontend
      run: |
        # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶
        pwd
        ls -la
        
        # å®‰è£…ä¾èµ–
        pnpm install
        
        # åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
        cat > .env.production << EOF
        VITE_API_BASE_URL=http://${{ env.SERVER_IP }}:8000
        VITE_APP_ENV=production
        VITE_API_TIMEOUT=300000
        VITE_DEBUG=false
        EOF
        
        # æ„å»ºé¡¹ç›®
        pnpm build
        
    - name: ğŸ—‚ï¸ Prepare Deployment Files
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deployment
        
        # å¤åˆ¶Pythonä»£ç 
        cp -r src deployment/
        cp -r config deployment/ 2>/dev/null || true
        cp requirements.txt deployment/
        cp api_server.py deployment/
        cp start_api_server.py deployment/
        cp main.py deployment/
        cp *.py deployment/ 2>/dev/null || true
        
        # å¤åˆ¶å‰ç«¯æ„å»ºæ–‡ä»¶
        mkdir -p deployment/frontend-dist
        cp -r src/chat_assistant/frontend/dist/* deployment/frontend-dist/
        

        
    - name: ğŸ“¤ Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # åˆ›å»ºåº”ç”¨ç›®å½•
          sudo mkdir -p /var/www/app
          sudo chown $USER:$USER /var/www/app
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf ${{ env.APP_DIR }}
          mkdir -p ${{ env.APP_DIR }}
          
    - name: ğŸ“ Upload Files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deployment/*"
        target: ${{ env.APP_DIR }}
        strip_components: 1
        
    - name: ğŸš€ Execute Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e  # å¦‚æœä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œç«‹å³é€€å‡º
          
          cd ${{ env.APP_DIR }}
          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
          pm2 stop product-auto-test 2>/dev/null || echo "æœåŠ¡æœªè¿è¡Œ"
          pm2 delete product-auto-test 2>/dev/null || echo "æœåŠ¡ä¸å­˜åœ¨"
          
          echo "ğŸ§¹ æ¸…ç†æ—§ç¯å¢ƒ..."
          rm -rf venv
          
          echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y python3-dev python3-pip python3-venv build-essential libopencv-dev
          
          echo "ğŸ åˆ›å»ºæ–°çš„Pythonè™šæ‹Ÿç¯å¢ƒ..."
          python3 -m venv venv
          source venv/bin/activate
          
          echo "ğŸ“ éªŒè¯Pythonç¯å¢ƒ..."
          which python
          python --version
          
          echo "â¬†ï¸ å‡çº§pip..."
          python -m pip install --upgrade pip
          
          echo "ğŸ§¹ æ¸…ç†pipç¼“å­˜..."
          pip cache purge
          
          echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
          pip install --no-cache-dir -r requirements.txt
          
          echo "âœ… éªŒè¯å…³é”®ä¾èµ–å®‰è£…..."
          python -c "import numpy; print(f'âœ… numpyç‰ˆæœ¬: {numpy.__version__}')"
          python -c "import cv2; print(f'âœ… opencvç‰ˆæœ¬: {cv2.__version__}')"
          python -c "import PIL; print(f'âœ… PILç‰ˆæœ¬: {PIL.__version__}')"
          python -c "import flask; print(f'âœ… Flaskç‰ˆæœ¬: {flask.__version__}')"
          
          echo "ğŸ§ª æµ‹è¯•é¡¹ç›®æ¨¡å—å¯¼å…¥..."
          python -c "
          import sys
          sys.path.append('.')
          try:
              import numpy as np
              print('âœ… numpyå¯¼å…¥æˆåŠŸ')
              from src.visual_comparison.comparator import VisualComparator
              print('âœ… VisualComparatorå¯¼å…¥æˆåŠŸ')
              from src.workflow.executor import WorkflowExecutor
              print('âœ… WorkflowExecutorå¯¼å…¥æˆåŠŸ')
              print('ğŸ‰ æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡!')
          except Exception as e:
              print(f'âŒ æ¨¡å—å¯¼å…¥æµ‹è¯•å¤±è´¥: {e}')
              exit(1)
          "
         
          echo "âš™ï¸ è®¾ç½®ç¯å¢ƒå˜é‡..."
          cat > .env << 'ENVEOF'
          FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_VERIFICATION_TOKEN=${{ secrets.FEISHU_VERIFICATION_TOKEN }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          FIGMA_ACCESS_TOKEN=${{ secrets.FIGMA_ACCESS_TOKEN }}
          ENVIRONMENT=production
          ENVEOF
          
          echo "ğŸ“ ç¡®è®¤Pythonè§£é‡Šå™¨è·¯å¾„..."
          PYTHON_PATH=$(pwd)/venv/bin/python
          echo "Pythonè§£é‡Šå™¨: $PYTHON_PATH"
          $PYTHON_PATH --version
          
          echo "ğŸš€ å¯åŠ¨PM2æœåŠ¡..."
          pm2 start api_server.py --name product-auto-test --interpreter $PYTHON_PATH
          
          echo "ğŸ’¾ ä¿å­˜PM2é…ç½®..."
          pm2 save
          
          echo "ğŸ“Š æ£€æŸ¥PM2çŠ¶æ€..."
          pm2 status
          
          echo "ğŸ“ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
          pm2 logs product-auto-test --lines 10
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
    - name: ğŸ” Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          echo "ğŸ“Š æ£€æŸ¥PM2è¿›ç¨‹çŠ¶æ€..."
          pm2 status
          
          echo "ğŸ“ æ£€æŸ¥æœåŠ¡æ—¥å¿—..."
          pm2 logs product-auto-test --lines 20
          
          echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          for i in {1..10}; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"
              curl -s http://localhost:8000/health
              break
            else
              echo "â³ æœåŠ¡è¿˜æœªå°±ç»ªï¼Œç­‰å¾…ä¸­... ($i/10)"
              if [ $i -eq 10 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š"
                pm2 logs product-auto-test --lines 50
                exit 1
              fi
              sleep 6
            fi
          done
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
        echo "  - å‰ç«¯ç•Œé¢: http://${{ env.SERVER_IP }}:8000"
        echo "  - APIæœåŠ¡: http://${{ env.SERVER_IP }}:8000/api"
        echo "  - å¥åº·æ£€æŸ¥: http://${{ env.SERVER_IP }}:8000/health"
        echo ""
        echo "ğŸ“Š æœåŠ¡æ¶æ„ï¼š"
        echo "  - å‰ç«¯: Nginxé™æ€æœåŠ¡"
        echo "  - åç«¯: PM2å®ˆæŠ¤è¿›ç¨‹"
        echo "  - ä»£ç†: Nginxåå‘ä»£ç†" 