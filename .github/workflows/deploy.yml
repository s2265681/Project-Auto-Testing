name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      run: |
        # è®¾ç½®SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # ä¸€é”®éƒ¨ç½²
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # åˆ›å»ºç›®å½•
          sudo mkdir -p /var/www/app
          sudo chown ubuntu:ubuntu /var/www/app
          
          # æ›´æ–°ä»£ç 
          cd /var/www/app
          if [ ! -d 'product-auto-test' ]; then
            git clone https://github.com/s2265681/Project-Aut-Testing.git product-auto-test
          fi
          cd product-auto-test
          git pull origin main
          
          # å®‰è£…ç³»ç»Ÿä¾èµ–
          sudo apt update -qq
          sudo apt install -y python3-pip nodejs npm
          
          # å®‰è£…Pythonä¾èµ–
          python3 -m pip install -r requirements.txt --user --quiet
          
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cat > .env << 'EOF'
        ENVIRONMENT=production
        FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN=${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN=${{ secrets.FIGMA_ACCESS_TOKEN }}
        EOF
          
          # å®‰è£…å’Œé…ç½®PM2
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2
          fi
          
          # é‡å¯æœåŠ¡
          pm2 delete product-auto-test 2>/dev/null || true
          pm2 start api_server.py --name product-auto-test --interpreter python3
          pm2 save
          
          echo 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼'
          echo 'æœåŠ¡å™¨åœ°å€: http://18.141.179.222:5001'
        " 