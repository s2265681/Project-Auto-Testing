# æœ€æ–°éƒ¨ç½²è„šæœ¬ - ä¿®å¤è™šæ‹Ÿç¯å¢ƒå’Œé€€å‡ºä»£ç é—®é¢˜ - 2024
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN: ${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
      run: |
        # è®¾ç½®SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        
        # åˆ›å»ºç›®å½•
        sudo mkdir -p /var/www/app
        sudo chown ubuntu:ubuntu /var/www/app
        echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
        
        # å®‰è£…ç³»ç»Ÿä¾èµ–
        echo "ğŸ“¦ æ›´æ–°ç³»ç»ŸåŒ…..."
        sudo apt update -qq
        sudo apt install -y python3-pip python3-venv git curl unzip
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
        
        # ä¸‹è½½ä»£ç 
        echo "ğŸ“¥ ä¸‹è½½ä»£ç ..."
        cd /var/www/app
        rm -rf product-auto-test
        
        if ! wget -q https://github.com/s2265681/Project-Auto-Testing/archive/refs/heads/main.zip; then
          echo "âŒ ä»£ç ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        if ! unzip -q main.zip; then
          echo "âŒ ä»£ç è§£å‹å¤±è´¥"
          exit 1
        fi
        
        mv Project-Auto-Testing-main product-auto-test
        rm main.zip
        cd product-auto-test
        echo "âœ… ä»£ç ä¸‹è½½å®Œæˆ"
        
        # åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
        echo "ğŸ åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ..."
        if ! python3 -m venv venv; then
          echo "âŒ è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸï¼Œæ£€æŸ¥å†…å®¹:"
        ls -la venv/bin/
        
        # æŸ¥æ‰¾æ­£ç¡®çš„Pythonè·¯å¾„
        if [ -f "venv/bin/python3" ]; then
          PYTHON_PATH="$(pwd)/venv/bin/python3"
          echo "âœ… æ‰¾åˆ°Pythonè·¯å¾„: $PYTHON_PATH"
        elif [ -f "venv/bin/python" ]; then
          PYTHON_PATH="$(pwd)/venv/bin/python"
          echo "âœ… æ‰¾åˆ°Pythonè·¯å¾„: $PYTHON_PATH"
        else
          echo "âŒ æœªæ‰¾åˆ°Pythonå¯æ‰§è¡Œæ–‡ä»¶"
          ls -la venv/bin/
          exit 1
        fi
        
        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        echo "ğŸ“š å®‰è£…Pythonä¾èµ–..."
        source venv/bin/activate
        
        echo "è™šæ‹Ÿç¯å¢ƒæ¿€æ´»æˆåŠŸ"
        which python
        python --version
        
        if ! pip install -r requirements.txt --quiet; then
          echo "âŒ Pythonä¾èµ–å®‰è£…å¤±è´¥"
          exit 1
        fi
        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
        
        # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
        echo "âš™ï¸ åˆ›å»ºç¯å¢ƒé…ç½®..."
        echo "ENVIRONMENT=production" > .env
        echo "FEISHU_APP_ID=\${FEISHU_APP_ID}" >> .env
        echo "FEISHU_APP_SECRET=\${FEISHU_APP_SECRET}" >> .env
        echo "FEISHU_VERIFICATION_TOKEN=\${FEISHU_VERIFICATION_TOKEN}" >> .env
        echo "GEMINI_API_KEY=\${GEMINI_API_KEY}" >> .env
        echo "FIGMA_ACCESS_TOKEN=\${FIGMA_ACCESS_TOKEN}" >> .env
        echo "âœ… ç¯å¢ƒæ–‡ä»¶åˆ›å»ºå®Œæˆ"
        
        # å®‰è£…Node.jså’ŒPM2
        echo "ğŸš€ è®¾ç½®PM2..."
        if ! command -v pm2 &> /dev/null; then
          echo "å®‰è£…Node.jså’ŒPM2..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          sudo npm install -g pm2
          echo "âœ… Node.jså’ŒPM2å®‰è£…å®Œæˆ"
        else
          echo "âœ… PM2å·²å­˜åœ¨"
        fi
        
        # é‡å¯æœåŠ¡
        echo "ğŸ”„ é‡å¯PM2æœåŠ¡..."
        pm2 delete product-auto-test 2>/dev/null || true
        
        # ä½¿ç”¨ç»å¯¹è·¯å¾„å¯åŠ¨PM2
        if ! pm2 start api_server.py --name product-auto-test --interpreter "$PYTHON_PATH"; then
          echo "âŒ PM2æœåŠ¡å¯åŠ¨å¤±è´¥"
          pm2 logs product-auto-test --lines 20
          exit 1
        fi
        
        pm2 save
        echo "âœ… PM2æœåŠ¡å¯åŠ¨å®Œæˆ"
        
        # éªŒè¯æœåŠ¡çŠ¶æ€
        echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
        pm2 status
        
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "æœåŠ¡å™¨åœ°å€: http://18.141.179.222:5001"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "éƒ¨ç½²æˆåŠŸï¼APIæœåŠ¡æ­£åœ¨è¿è¡Œ"
        EOF
        
        # ä¼ è¾“å¹¶æ‰§è¡Œè„šæœ¬
        scp -o StrictHostKeyChecking=no deploy_script.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "FEISHU_APP_ID='$FEISHU_APP_ID' \
           FEISHU_APP_SECRET='$FEISHU_APP_SECRET' \
           FEISHU_VERIFICATION_TOKEN='$FEISHU_VERIFICATION_TOKEN' \
           GEMINI_API_KEY='$GEMINI_API_KEY' \
           FIGMA_ACCESS_TOKEN='$FIGMA_ACCESS_TOKEN' \
           bash /tmp/deploy_script.sh" 