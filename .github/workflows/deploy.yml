# å¥å£®çš„éƒ¨ç½²è„šæœ¬ - ä¿®å¤SSHè¿æ¥å’ŒæŒ‡çº¹é—®é¢˜ - 2024
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Server
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN: ${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SSH_PORT: ${{ secrets.SSH_PORT }}
      run: |
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        
        # éªŒè¯å¿…è¦çš„ç¯å¢ƒå˜é‡
        if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡"
          echo "SSH_PRIVATE_KEY: $([ -n "$SSH_PRIVATE_KEY" ] && echo 'å·²è®¾ç½®' || echo 'æœªè®¾ç½®')"
          echo "SERVER_HOST: $([ -n "$SERVER_HOST" ] && echo 'å·²è®¾ç½®' || echo 'æœªè®¾ç½®')"
          echo "SERVER_USER: $([ -n "$SERVER_USER" ] && echo 'å·²è®¾ç½®' || echo 'æœªè®¾ç½®')"
          exit 1
        fi
        
        # è®¾ç½®SSHç«¯å£
        SSH_PORT=${SSH_PORT:-22}
        echo "ğŸ“¡ SSHé…ç½®ä¿¡æ¯:"
        echo "  - æœåŠ¡å™¨: $SERVER_HOST"
        echo "  - ç”¨æˆ·: $SERVER_USER" 
        echo "  - ç«¯å£: $SSH_PORT"
        
        # è®¾ç½®SSH
        echo "ğŸ”‘ é…ç½®SSHè¿æ¥..."
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # éªŒè¯ç§é’¥æ ¼å¼
        if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "âŒ SSHç§é’¥æ ¼å¼æ— æ•ˆ"
          exit 1
        fi
        echo "âœ… SSHç§é’¥éªŒè¯é€šè¿‡"
        
        # ç½‘ç»œè¿æ¥æµ‹è¯•
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
        if ! timeout 10 bash -c "echo >/dev/tcp/$SERVER_HOST/$SSH_PORT" 2>/dev/null; then
          echo "âŒ æ— æ³•è¿æ¥åˆ° $SERVER_HOST:$SSH_PORT"
          echo "ğŸ” è¯Šæ–­ä¿¡æ¯:"
          echo "  - è¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®"
          echo "  - è¯·æ£€æŸ¥SSHç«¯å£æ˜¯å¦æ­£ç¡®"
          echo "  - è¯·æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
          echo "  - è¯·æ£€æŸ¥SSHæœåŠ¡æ˜¯å¦è¿è¡Œ"
          
          # å°è¯•pingæµ‹è¯•
          echo "ğŸ“¡ å°è¯•pingæµ‹è¯•..."
          if ping -c 3 -W 5 "$SERVER_HOST" > /dev/null 2>&1; then
            echo "âœ… æœåŠ¡å™¨å¯ä»¥pingé€š"
          else
            echo "âŒ æœåŠ¡å™¨æ— æ³•pingé€š"
          fi
          exit 1
        fi
        echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
        
        # SSHé…ç½®
        cat > ~/.ssh/config << 'SSH_CONFIG'
        Host deploy-server
            HostName ${SERVER_HOST}
            User ${SERVER_USER}
            Port ${SSH_PORT}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            IdentityFile ~/.ssh/id_rsa
            ConnectTimeout 30
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
        SSH_CONFIG
        
        # æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡
        sed -i "s/\${SERVER_HOST}/$SERVER_HOST/g" ~/.ssh/config
        sed -i "s/\${SERVER_USER}/$SERVER_USER/g" ~/.ssh/config  
        sed -i "s/\${SSH_PORT}/$SSH_PORT/g" ~/.ssh/config
        chmod 600 ~/.ssh/config
        
        # æµ‹è¯•SSHè¿æ¥
        echo "ğŸ§ª æµ‹è¯•SSHè¿æ¥..."
        if ! timeout 60 ssh deploy-server "echo 'SSHè¿æ¥æµ‹è¯•æˆåŠŸ'"; then
          echo "âŒ SSHè¿æ¥å¤±è´¥"
          echo "ğŸ” è¯¦ç»†è°ƒè¯•ä¿¡æ¯:"
          timeout 30 ssh -vvv deploy-server "echo 'test'" 2>&1 || true
          echo ""
          echo "ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:"
          echo "  1. æ£€æŸ¥SSHå¯†é’¥æ˜¯å¦å·²æ·»åŠ åˆ°æœåŠ¡å™¨authorized_keys"
          echo "  2. ç¡®è®¤æœåŠ¡å™¨ç”¨æˆ·åæ­£ç¡®"
          echo "  3. æ£€æŸ¥æœåŠ¡å™¨SSHé…ç½®æ–‡ä»¶"
          echo "  4. ç¡®è®¤é˜²ç«å¢™å…è®¸SSHè¿æ¥"
          exit 1
        fi
        echo "âœ… SSHè¿æ¥æµ‹è¯•æˆåŠŸ"
        
        # æ‰“åŒ…ä»£ç 
        echo "ğŸ“¦ æ‰“åŒ…ä»£ç ..."
        tar -czf app.tar.gz --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' .
        
        # ä¸Šä¼ ä»£ç 
        echo "ğŸ“¤ ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨..."
        scp app.tar.gz deploy-server:/tmp/
        
        # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²
        echo "ğŸ¯ æ‰§è¡Œè¿œç¨‹éƒ¨ç½²..."
        ssh deploy-server "
        set -e
        
        echo 'ğŸ”§ å¼€å§‹æœåŠ¡å™¨ç«¯éƒ¨ç½²...'
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FEISHU_APP_ID='$FEISHU_APP_ID'
        export FEISHU_APP_SECRET='$FEISHU_APP_SECRET'
        export FEISHU_VERIFICATION_TOKEN='$FEISHU_VERIFICATION_TOKEN'
        export GEMINI_API_KEY='$GEMINI_API_KEY'
        export FIGMA_ACCESS_TOKEN='$FIGMA_ACCESS_TOKEN'
        
        # éƒ¨ç½²ä»£ç 
        echo 'ğŸ“ å‡†å¤‡åº”ç”¨ç›®å½•...'
        sudo mkdir -p /var/www/app
        sudo chown \$USER:\$USER /var/www/app
        cd /var/www/app
        
        # å¤‡ä»½æ—§ç‰ˆæœ¬
        if [ -d 'current' ]; then
          echo 'ğŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬...'
          mv current backup-\$(date +%Y%m%d-%H%M%S)
        fi
        
        # è§£å‹æ–°ä»£ç 
        echo 'ğŸ“‚ è§£å‹æ–°ä»£ç ...'
        mkdir current
        tar -xzf /tmp/app.tar.gz -C current
        cd current
        
        # æ£€æŸ¥Pythonç¯å¢ƒ
        echo 'ğŸ æ£€æŸ¥Pythonç¯å¢ƒ...'
        python3 --version
        
        # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        echo 'ğŸ”¨ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...'
        python3 -m venv venv
        source venv/bin/activate
        
        # å‡çº§pip
        pip install --upgrade pip
        
        # å®‰è£…ä¾èµ–
        echo 'ğŸ“š å®‰è£…ä¾èµ–...'
        if [ -f 'requirements.txt' ]; then
          pip install -r requirements.txt
        else
          echo 'âš ï¸ æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶'
        fi
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo 'âš™ï¸ åˆ›å»ºç¯å¢ƒé…ç½®...'
        cat > .env << 'ENVFILE'
        FEISHU_APP_ID=\$FEISHU_APP_ID
        FEISHU_APP_SECRET=\$FEISHU_APP_SECRET
        FEISHU_VERIFICATION_TOKEN=\$FEISHU_VERIFICATION_TOKEN
        GEMINI_API_KEY=\$GEMINI_API_KEY
        FIGMA_ACCESS_TOKEN=\$FIGMA_ACCESS_TOKEN
        ENVIRONMENT=production
        ENVFILE
        
        # æ£€æŸ¥ä¸»æ–‡ä»¶
        if [ ! -f 'api_server.py' ]; then
          echo 'âŒ api_server.py æ–‡ä»¶ä¸å­˜åœ¨'
          ls -la
          exit 1
        fi
        
        # PM2 éƒ¨ç½² (ç®€åŒ–ç‰ˆæœ¬ï¼Œå‡è®¾å·²å®‰è£…)
        echo 'ğŸ”„ é‡å¯PM2æœåŠ¡...'
        pm2 delete product-auto-test 2>/dev/null || true
        pm2 start api_server.py --name product-auto-test --interpreter \$(pwd)/venv/bin/python
        pm2 save
        
        # éªŒè¯æœåŠ¡
        echo 'ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€...'
        sleep 3
        pm2 status
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm /tmp/app.tar.gz
        
        echo 'âœ… éƒ¨ç½²å®Œæˆï¼'
        echo 'ğŸ“ é¡¹ç›®è·¯å¾„: '\$(pwd)
        "
        
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼" 