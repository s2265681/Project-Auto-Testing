name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      run: |
        # 设置SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # 一键部署
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # 创建目录
          sudo mkdir -p /var/www/app
          sudo chown ubuntu:ubuntu /var/www/app
          
          # 安装系统依赖（先安装基础包）
          sudo apt update -qq
          sudo apt install -y python3-pip git curl
          
          # 使用wget下载代码包而不是git clone
          cd /var/www/app
          rm -rf product-auto-test
          wget -q https://github.com/s2265681/Project-Auto-Testing/archive/refs/heads/main.zip
          unzip -q main.zip
          mv Project-Auto-Testing-main product-auto-test
          rm main.zip
          cd product-auto-test
          
          # 安装Python依赖
          python3 -m pip install -r requirements.txt --user --quiet
          
          # 创建环境文件
          cat > .env << 'EOF'
        ENVIRONMENT=production
        FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN=${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN=${{ secrets.FIGMA_ACCESS_TOKEN }}
        EOF
          
          # 安装Node.js和PM2（使用NVM避免依赖冲突）
          if ! command -v pm2 &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g pm2
          fi
          
          # 重启服务
          pm2 delete product-auto-test 2>/dev/null || true
          pm2 start api_server.py --name product-auto-test --interpreter python3
          pm2 save
          
          echo '🎉 部署完成！'
          echo '服务器地址: http://18.141.179.222:5001'
          echo '当前目录: $(pwd)'
          echo '文件列表: $(ls -la)'
        " 