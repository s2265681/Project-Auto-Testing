name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      run: |
        # è®¾ç½®SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # ä¸€é”®éƒ¨ç½²
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          
          echo 'ğŸš€ å¼€å§‹éƒ¨ç½²...'
          
          # åˆ›å»ºç›®å½•
          sudo mkdir -p /var/www/app
          sudo chown ubuntu:ubuntu /var/www/app
          echo 'âœ… ç›®å½•åˆ›å»ºå®Œæˆ'
          
          # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…å«unzipï¼‰
          sudo apt update -qq
          sudo apt install -y python3-pip python3-venv git curl unzip
          echo 'âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ'
          
          # ä¸‹è½½ä»£ç 
          cd /var/www/app
          rm -rf product-auto-test
          wget -q https://github.com/s2265681/Project-Auto-Testing/archive/refs/heads/main.zip
          unzip -q main.zip
          mv Project-Auto-Testing-main product-auto-test
          rm main.zip
          cd product-auto-test
          echo 'âœ… ä»£ç ä¸‹è½½å®Œæˆ'
          
          # åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
          echo 'å¼€å§‹åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...'
          python3 -m venv venv
          echo 'è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œæ£€æŸ¥ç»“æœ...'
          ls -la venv/
          echo 'æ£€æŸ¥venv/binç›®å½•å†…å®¹:'
          ls -la venv/bin/
          echo 'âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ'
          
          # æŸ¥æ‰¾æ­£ç¡®çš„Pythonè·¯å¾„
          if [ -f 'venv/bin/python3' ]; then
            PYTHON_PATH='venv/bin/python3'
            echo 'âœ… æ‰¾åˆ°Pythonè·¯å¾„: venv/bin/python3'
          elif [ -f 'venv/bin/python' ]; then
            PYTHON_PATH='venv/bin/python'
            echo 'âœ… æ‰¾åˆ°Pythonè·¯å¾„: venv/bin/python'
          else
            echo 'âŒ æœªæ‰¾åˆ°Pythonå¯æ‰§è¡Œæ–‡ä»¶'
            echo 'venv/binç›®å½•å†…å®¹:'
            ls -la venv/bin/
            exit 1
          fi
          
          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
          source venv/bin/activate
          echo 'è™šæ‹Ÿç¯å¢ƒæ¿€æ´»æˆåŠŸ'
          which python
          python --version
          pip install -r requirements.txt --quiet
          echo 'âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ'
          
          # åˆ›å»ºç¯å¢ƒæ–‡ä»¶
          cat > .env << 'EOF'
        ENVIRONMENT=production
        FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN=${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN=${{ secrets.FIGMA_ACCESS_TOKEN }}
        EOF
          echo 'âœ… ç¯å¢ƒæ–‡ä»¶åˆ›å»ºå®Œæˆ'
          
          # å®‰è£…Node.jså’ŒPM2
          if ! command -v pm2 &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g pm2
            echo 'âœ… Node.jså’ŒPM2å®‰è£…å®Œæˆ'
          else
            echo 'âœ… PM2å·²å­˜åœ¨'
          fi
          
          # é‡å¯æœåŠ¡
          pm2 delete product-auto-test 2>/dev/null || true
          pm2 start api_server.py --name product-auto-test --interpreter \$PYTHON_PATH
          pm2 save
          echo 'âœ… PM2æœåŠ¡å¯åŠ¨å®Œæˆ'
          
          # æœ€åçš„æˆåŠŸä¿¡æ¯ï¼ˆå…³é—­ä¸¥æ ¼é”™è¯¯æ£€æŸ¥ï¼‰
          set +e
          echo 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼'
          echo 'æœåŠ¡å™¨åœ°å€: http://18.141.179.222:5001'
          echo 'å½“å‰ç›®å½•: '\$(pwd)''
          pwd
          echo 'éƒ¨ç½²æˆåŠŸï¼APIæœåŠ¡æ­£åœ¨è¿è¡Œ'
          exit 0
        " 