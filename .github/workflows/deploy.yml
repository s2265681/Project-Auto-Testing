# å¥å£®çš„éƒ¨ç½²è„šæœ¬ - ä¿®å¤SSHè¿æ¥å’ŒæŒ‡çº¹é—®é¢˜ - 2024
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Server
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_VERIFICATION_TOKEN: ${{ secrets.FEISHU_VERIFICATION_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SSH_PORT: ${{ secrets.SSH_PORT }}
      run: |
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        
        # è®¾ç½®SSH
        echo "ğŸ”‘ è®¾ç½®SSHè¿æ¥..."
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # è®¾ç½®SSHç«¯å£
        SSH_PORT=${SSH_PORT:-22}
        echo "ğŸ“¡ SSHç«¯å£: $SSH_PORT"
        
        # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
        ssh-keyscan -p $SSH_PORT $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # æµ‹è¯•SSHè¿æ¥
        echo "ğŸ§ª æµ‹è¯•SSHè¿æ¥..."
        if ! ssh -p $SSH_PORT -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST "echo 'SSHè¿æ¥æˆåŠŸ'"; then
          echo "âŒ SSHè¿æ¥å¤±è´¥"
          exit 1
        fi
        
        # æ‰“åŒ…ä»£ç 
        echo "ğŸ“¦ æ‰“åŒ…ä»£ç ..."
        tar -czf app.tar.gz --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' .
        
        # ä¸Šä¼ ä»£ç 
        echo "ğŸ“¤ ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨..."
        scp -P $SSH_PORT app.tar.gz $SERVER_USER@$SERVER_HOST:/tmp/
        
        # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²
        echo "ğŸ¯ æ‰§è¡Œè¿œç¨‹éƒ¨ç½²..."
        ssh -p $SSH_PORT $SERVER_USER@$SERVER_HOST "
        set -e
        
        echo 'ğŸ”§ å¼€å§‹æœåŠ¡å™¨ç«¯éƒ¨ç½²...'
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FEISHU_APP_ID='$FEISHU_APP_ID'
        export FEISHU_APP_SECRET='$FEISHU_APP_SECRET'
        export FEISHU_VERIFICATION_TOKEN='$FEISHU_VERIFICATION_TOKEN'
        export GEMINI_API_KEY='$GEMINI_API_KEY'
        export FIGMA_ACCESS_TOKEN='$FIGMA_ACCESS_TOKEN'
        
        # éƒ¨ç½²ä»£ç 
        echo 'ğŸ“ å‡†å¤‡åº”ç”¨ç›®å½•...'
        sudo mkdir -p /var/www/app
        sudo chown \$USER:\$USER /var/www/app
        cd /var/www/app
        
        # å¤‡ä»½æ—§ç‰ˆæœ¬
        if [ -d 'current' ]; then
          echo 'ğŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬...'
          mv current backup-\$(date +%Y%m%d-%H%M%S)
        fi
        
        # è§£å‹æ–°ä»£ç 
        echo 'ğŸ“‚ è§£å‹æ–°ä»£ç ...'
        mkdir current
        tar -xzf /tmp/app.tar.gz -C current
        cd current
        
        # æ£€æŸ¥Pythonç¯å¢ƒ
        echo 'ğŸ æ£€æŸ¥Pythonç¯å¢ƒ...'
        python3 --version
        
        # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        echo 'ğŸ”¨ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...'
        python3 -m venv venv
        source venv/bin/activate
        
        # å‡çº§pip
        pip install --upgrade pip
        
        # å®‰è£…ä¾èµ–
        echo 'ğŸ“š å®‰è£…ä¾èµ–...'
        if [ -f 'requirements.txt' ]; then
          pip install -r requirements.txt
        else
          echo 'âš ï¸ æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶'
        fi
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo 'âš™ï¸ åˆ›å»ºç¯å¢ƒé…ç½®...'
        cat > .env << 'ENVFILE'
        FEISHU_APP_ID=\$FEISHU_APP_ID
        FEISHU_APP_SECRET=\$FEISHU_APP_SECRET
        FEISHU_VERIFICATION_TOKEN=\$FEISHU_VERIFICATION_TOKEN
        GEMINI_API_KEY=\$GEMINI_API_KEY
        FIGMA_ACCESS_TOKEN=\$FIGMA_ACCESS_TOKEN
        ENVIRONMENT=production
        ENVFILE
        
        # æ£€æŸ¥ä¸»æ–‡ä»¶
        if [ ! -f 'api_server.py' ]; then
          echo 'âŒ api_server.py æ–‡ä»¶ä¸å­˜åœ¨'
          ls -la
          exit 1
        fi
        
        # å®‰è£…æˆ–æ£€æŸ¥PM2
        echo 'ğŸš€ é…ç½®PM2...'
        if ! command -v pm2 &> /dev/null; then
          echo 'å®‰è£…PM2...'
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
          export NVM_DIR='\$HOME/.nvm'
          [ -s '\$NVM_DIR/nvm.sh' ] && \. '\$NVM_DIR/nvm.sh'
          nvm install node
          npm install -g pm2
        fi
        
        # PM2 éƒ¨ç½²
        echo 'ğŸ”„ é‡å¯PM2æœåŠ¡...'
        pm2 delete product-auto-test 2>/dev/null || true
        pm2 start api_server.py --name product-auto-test --interpreter \$(pwd)/venv/bin/python
        pm2 save
        
        # éªŒè¯æœåŠ¡
        echo 'ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€...'
        sleep 3
        pm2 status
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm /tmp/app.tar.gz
        
        echo 'âœ… éƒ¨ç½²å®Œæˆï¼'
        echo 'ğŸ“ é¡¹ç›®è·¯å¾„: '\$(pwd)
        echo 'ğŸ” æœåŠ¡çŠ¶æ€: '\$(pm2 list | grep product-auto-test || echo 'æœªæ‰¾åˆ°æœåŠ¡')
        "
        
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼" 